# 2025-09-29

## 学んだこと

### CORS エラーの表面的な症状に惑わされない重要性

今日、フロントエンドで「CORS policy: No 'Access-Control-Allow-Origin' header…」と表示される問題に遭遇した。しかし、真の原因は**バックエンドの Redis 接続失敗による内部 500 エラー**だった。

#### 問題の構造

- **表面症状**: ブラウザコンソールに CORS エラー様の表示
- **真因**: `.env`の`REDIS_URL=redis://redis:6379/0`が Docker 前提の設定だったが、FastAPI をホスト環境（macOS）で直接起動していたため名前解決に失敗
- **影響範囲**: 与信スコア算出 API（`POST /api/v1/applications/{id}/score`）のみ

#### なぜ CORS エラーに見えるのか

ブラウザは「クロスオリジン返却を閲覧できない」ケースを十把一絡げに CORS エラーとして表示する。内部 500 で CORS ヘッダが抜けた場合でも同じ文言が出るため、**ミスリードを誘発しやすい**。

#### 調査の決め手となった観測

1. 他の API（`/applications POST`）は正常に動作 → CORS 設定自体は機能している
2. `/healthz`に Origin ヘッダを付与してテスト → `Access-Control-Allow-Origin`ヘッダが正常に返却
3. スコア算出のみ 500 (UNHANDLED) → ルート内部例外の可能性
4. **サーバーログの traceback**: `redis.exceptions.ConnectionError` → Redis 名前解決失敗確定

### 実行環境による設定の使い分けの重要性

Docker Compose と Host 実行で異なる接続文字列が必要：

- **Docker Compose**: `redis://redis:6379/0` （サービス名で名前解決）
- **Host 実行**: `redis://localhost:6379/0` （ローカルホストで接続）

### エラーハンドリングの改善点

Redis 接続失敗時の例外が未捕捉で 500 エラーになっていた。外部依存の初期化失敗は明示的なエラーコード（例：`REDIS_UNAVAILABLE`）で返すべき。

## 苦労したこと・できなかったこと

### 初期調査での時間ロス

最初の 30 分程度は「CORS エラー」という表面的な症状に引っ張られて、CORS 設定の見直しに時間を費やしてしまった。他の API が正常に動作していることに気づくのが遅れた。

### サーバーログの確認が後回しになった

フロントエンドのエラー表示に注目しすぎて、**バックエンドのログ確認が後回し**になった。最初からサーバーログを見ていれば、Redis ConnectionError の traceback で即座に原因を特定できた。

### 環境依存の設定管理

開発環境で Docker Compose と Host 実行を混在させる際の設定管理について、事前にドキュメント化や自動切り替えの仕組みを整備できていなかった。

### 例外処理の不備

Redis 接続失敗時の適切な例外処理を実装していなかったため、内部エラーが 500 として返却され、原因の特定が困難になった。

## 対応と今後の改善策

### 即座に実施した対応

1. `.env`の`REDIS_URL`を`redis://localhost:6379/0`に修正
2. Redis 起動確認（`redis-cli PING`）
3. FastAPI 再起動
4. スコア算出 API 動作確認 → 正常化

### 今後の予防策

1. **起動時 Redis PING & ログ警告**の実装
2. **README 強化**: Host 実行時の設定について強調記載
3. **Redis 接続失敗時の明示的エラーレスポンス**実装
4. **/healthz/redis エンドポイント**追加による可観測性向上
5. **エラー監視ツール**（Sentry 等）導入検討

### 教訓

- 「CORS エラー表示」≠「CORS 設定不備」
- 外部依存を使うエンドポイントでは依存初期化失敗の明示コード化が重要
- 実行形態による設定差異は「間違いやすいポイント」として強調すべき

**要約**: 表面的な CORS 風エラーの真因が Redis ホスト名 misconfig による内部 500 だった。REDIS_URL を localhost 修正で復旧。初期調査でサーバーログ確認を優先すべきだった。
